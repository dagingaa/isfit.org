<h1>Organization structure</h1>

<% column_count = 3 %>

<div class="table">
	<div class="column">You are here:</div>
	<div>
<%= 
	parts = @unit.dn.split(",")
	pos = 0
	str = ""
	parts[0..-4].each do |part|
		part_unit = LdapUnit.get_by_dn(parts[pos..-1].join(","))
		str = " &gt; #{link_to(part_unit.description, {:controller =>
			"unit", :action => "show", :id => part_unit.dn})}#{str}"
		pos = pos + 1
	end
	str = "#{link_to("ISFiT", {:id => "ou=units,dc=isfit,dc=org"})}#{str}"
%>
	</div>
	
	<div class="column">Search for a functionary. Type name or phone number:</div>
	<div>
		<%= form_tag ({:action=> "show", :id => params[:id]} ) %>
		<%= text_field_tag :query, @query %>
		<%= submit_tag "Search" %>
	</div>
</div>
<%

if(!@search)
	%>
	<h2>Unit details</h2>
	<div class="table">
		<div class="column"><b>Name</b>:</div>
		<div>
			<%= @unit.description %>
		</div>

		<div class="column"><b>E-mail(s)</b>:</div>
		<div>
			<%= 
				emails = [] 
				if @unit.group
					emails = @unit.group.mails.collect do |email|
						unless email.index('@')
							email += '@isfit.org'
						end
						email
					end
				end

				unless emails.empty?
					emails.join(", ")
				else
					'(None)'
				end
			%>
		</div>
	</div>
	<% unless @unit.units.empty? 
	units = @unit.units.sort do |a, b|
		a.name <=> b.name
	end
	%>
	<p><b>Belonging units</b> (<%= units.size %>):</p>
	<div>
	<% column = 0 %>
	<%
	units.each do |unit|
	%>
	<% column += 1 %>
	<% if (column%column_count == 1 && column != 1) %>
		<div class="clear"></div>
	</div>
	<div>
	<% end %>
	<div class="unit">
	<%= "#{link_to(unit.description, {:controller => "unit", :action =>
			"show", :id => unit.dn})}" %>
	</div>
	<% end %>
	</div>
	<% end %>

<% end %>
<%
unless @search
	@functionaries = @unit.functionaries(true)
end
%>
<% unless @functionaries.empty? %>
<div class="clear"></div>
<p style="clear: both"><b>Functionaries</b> (<%= @functionaries.size 
	%>):</p>
    <% functionaries = @functionaries.sort do |a, b|
            a.lastname <=> b.lastname
        end
	%>
	<% column = 0; prev_functionary = nil %>
	<div>
		<div class="functionaries">
			<p class="letterline"><%= functionaries[0].lastname.first %></p>
			<% functionaries.each do |functionary|
			   	   if prev_functionary != nil && prev_functionary.lastname[0] !=
					   functionary.lastname[0]
						column += 1 %>
		</div>
		
	<% if column%column_count == 0 && column != 1 %>
		<div class="clear"></div>
	</div>
	<div>
	<% end %>
		<div class="functionaries">
			<p class="letterline"><%= functionary.lastname.first %></p>
				<% end %>
			<% if @unit.units.empty? %>
			<div class="functionary_noimage">
			
				<div>
					<% if FileTest.exists?("#{RAILS_ROOT}/public/images/profile_images/#{functionary.id}.jpg")%>
						<%= link_to ((image_tag ("profile_images/#{functionary.id}.jpg" ,:align=>"left", :width=>"110", :alt=> "", :border=>0 )), { :controller => "user",:action => "show", :id => functionary.dn}) %>
					<% else %>
						<%= image_tag "profile_images/NoPictureAvailable.jpg" ,:align=>"left", :width=>"110", :alt=> "" %>
					<% end %>
				</div>
				<p class="letterline_noimage">
			<%else%>
				<div class="functionary">
			<%end%>
				
				<%= link_to("#{functionary.lastname}, 
					#{functionary.firstname}", 
					{:controller => "user",:action => "show", :id => functionary.dn}) %><br />
					
				<%= functionary.title %><br />
				<%= functionary.username ? 
					"#{functionary.username}@isfit.org" : '' %>
				</div>
			</p>
		<% prev_functionary = functionary %>
		   <% end %>
		</div>
	</div>
<% end %>
<% if @functionaries.empty? %>
<%= "<br><h4>No functionaries matched with: " + @query +"<h4>"%>
<%end%>
